<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body
  {
    font-family:Century Gothic,Arial,Helvetica,sans-serif;
    padding-bottom: 40px;
  }
  p
  {
    margin-top:20px;
    font-size:1.2em;
  }
  form
  {
    position: absolute;
    left: 10px;
    top: 10px;
  }

  #code_hierarchy
  {
    margin:0 auto;
    height:1300px;
    width:1300px;
  }

  #code_hierarchy_legend
  {
    height:80px;
    float:right;padding-top:80px;
    text-align:center;
  }

  path
  {
    stroke: #fff;
  }
  path.hovered
  {
    stroke: #feb24c;
    stroke-width : 2;
    stroke-opacity: 1;
  }
  path.active
  {
    stroke: #fc4e2a;
    stroke-width : 2;
    stroke-opacity: 1;
  }
</style>
<body>
  <form>
    <label><input type="radio" name="mode" value="2015" checked> 2015</label>
    <label><input type="radio" name="mode" value="2016"> 2016</label>
  </form>
	<div id="body">
		<div class="container">
			<div class="row-fluid">
				<div class="span6">
					<div id="code_hierarchy">
					</div>
				</div>
				<div class="span4 pull-right">
					<div style="opacity: 0;" id="code_hierarchy_legend"><h2></h2><p></p></div>
				</div>
			</div>
		</div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script>
    $(document).ready(function() {

      $("input").on("change", function() {
        switch(this.value)
        {
          case "2015":
            init_plots(heriarchy_2015);
            break;
          case "2016":
            init_plots(heriarchy_2016);
            break;
        }
      });

      function init_code_hierarchy_plot(element_id,data)
      {
        var plot = document.getElementById(element_id);
        while (plot.hasChildNodes())
        {
            plot.removeChild(plot.firstChild);
        }

        var width = plot.offsetWidth;
        var height = width;
        var x_margin = 40;
        var radius = width/7;
        var y_margin = 40;
        var name_index = 0;
        var count_index = 1;
        var children_index = 3;
        var max_depth=50;
        var data_slices = [];
        var max_level = 10;
        var color = d3.scale.category20c();

        var svg = d3.select("#"+element_id).append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height * .52 + ")");

        function process_data(data,level,start_deg,stop_deg)
        {
            var name = data[0];
            var total = data[1];
            var children = data[3];
            var current_deg = start_deg;
    		    var parent = '';

            if (level > max_level)
            {
                return;
            }
            if (start_deg == stop_deg)
            {
                return;
            }


            data_slices.push([start_deg,stop_deg,name,level,data[1],data[2]]);

            for (var key in children)
            {
                child = children[key];

    			var inc_deg = (stop_deg-start_deg)/total*child[count_index];
                var child_start_deg = current_deg;

    			current_deg+=inc_deg;

    			var child_stop_deg = current_deg;
                var span_deg = child_stop_deg-child_start_deg;

    			process_data(child,level+1,child_start_deg,child_stop_deg);
            }
        }

        process_data(data,0,0,360./180.0*Math.PI);

        var ref = data_slices[0];
        var next_ref = ref;
        var last_refs = [];

        var thickness = width/2.0/(max_level+2)*1.1;

        var arc = d3.svg.arc()
          .startAngle(function(d) { if(d[3]==0){return d[0];}return d[0]+0.01; })
          .endAngle(function(d) { if(d[3]==0){return d[1];}return d[1]-0.01; })
          .innerRadius(function(d) { return 1.1*d[3]*thickness; })
          .outerRadius(function(d) { return (1.1*d[3]+1)*thickness; });

        var slices = svg.selectAll(".form-container")
          .data(function(d) { return data_slices; })
          .enter()
          .append("g")
          .classed('form-container', true);

        slices.append("path")
          .attr("d", arc)
          .attr("id",function(d,i){return d[2]+""+i;})
          .style("fill", function(d) { return color(d[2]);})
          .on("click",animate)
          .attr("class","form")
          .append("svg:title")
          .text(function(d) { return Math.round(d[0]*100)/100 +" , "+ Math.round(d[1]*100)/100; });

        slices.append("text")
          .classed('label', true)
          .style("font-size", "10px")
      	  .attr("x", function(d) { return d[1]; })
          .attr("text-anchor", "middle")
      		.attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")" + "rotate(" + getAngle(d) + ")"; })
      		.attr("dx", "0") // margin
      		.attr("dy", ".35em") // vertical-align
      		.text(function(d){return d[2]})
          .attr("pointer-events","none");

        function getAngle(d) {
          //var thetaDeg = (180 / Math.PI * (arc.startAngle()(d) + arc.endAngle()(d)) / 2 - 90);
          var thetaDeg = (180 / Math.PI * (arc.startAngle()(d) + arc.endAngle()(d)) / 2);
          return (thetaDeg > 90) ? thetaDeg - 180 : thetaDeg;
        }

        function get_start_angle(d,ref)
        {
            if (ref)
            {
                var ref_span = ref[1]-ref[0];
                return (d[0]-ref[0])/ref_span*Math.PI*2.0
            }
            else
            {
                return d[0];
            }
        }

        function get_stop_angle(d,ref)
        {
            if (ref)
            {
                var ref_span = ref[1]-ref[0];
                return (d[1]-ref[0])/ref_span*Math.PI*2.0
            }
            else
            {
                return d[0];
            }
        }

        function get_level(d,ref)
        {
            if (ref)
            {
                return d[3]-ref[3];
            }
            else
            {
                return d[3];
            }
        }

        function change_ref(data_point, reference_point) {
            return [
                get_start_angle(data_point, reference_point),
                get_stop_angle (data_point, reference_point),
                data_point[2],
                get_level      (data_point, reference_point)
            ];
        }

        function rebaseTween(new_ref)
        {
            return function(d)
            {
                var level = d3.interpolate(get_level(d,ref),get_level(d,new_ref));
                var start_deg = d3.interpolate(get_start_angle(d,ref),get_start_angle(d,new_ref));
                var stop_deg = d3.interpolate(get_stop_angle(d,ref),get_stop_angle(d,new_ref));
                var opacity = d3.interpolate(100,0);
                return function(t)
                {
                    return arc([start_deg(t),stop_deg(t),d[2],level(t)]);
                }
            }
        }

        var animating = false;

        function animate(d)
    	  {
  		    d3.select(this).classed('active',true).classed('hovered',false);
          if (animating)
          {
              return;
          }
          animating = true;
          var revert = false;
          var new_ref;
          if (d == ref && last_refs.length > 0)
          {
              revert = true;
              last_ref = last_refs.pop();
          }
          if (revert)
          {
            d = last_ref;
            new_ref = ref;
            svg.selectAll(".form-container")
            .filter(
                function (b)
                {
                    if (b[0] >= last_ref[0] && b[1] <= last_ref[1]  && b[3] >= last_ref[3])
                    {
                        return true;
                    }
                    return false;
                }
            )
            .transition().duration(1000).style("opacity","1").attr("pointer-events","all");
          }
          else
          {
            new_ref = d;
            svg.selectAll(".form-container")
            .filter(
                function (b)
                {
                  if (b[2] == "Sales Ops") {
                    console.log(b);
                    console.log(d);
                  }
                  if (b[0] < d[0] || b[1] > d[1] || b[3] < d[3])
                  {
                    return true;
                  }
                  return false;
                }
            )
            .transition().duration(1000).style("opacity","0").attr("pointer-events","none");
          }
          svg.selectAll(".form")
          .filter(
            function (b)
            {
              if (b[0] >= new_ref[0] && b[1] <= new_ref[1] && b[3] >= new_ref[3])
              {
                  return true;
              }
              return false;
            }
          )
          .transition().duration(1000).attrTween("d",rebaseTween(d));

          svg.selectAll('.label')
          .filter(
              function (b)
              {
                  return b[0] >= new_ref[0] && b[1] <= new_ref[1] && b[3] >= new_ref[3];
              }
          ).transition().duration(1000)
           .attr("transform", function(b) {
               var b_prime = change_ref(b, d);
               return "translate(" + arc.centroid(b_prime) + ")" +
                      "rotate("    + getAngle(b_prime) +     ")";
           })

          setTimeout(function(){
            animating = false;
            if (! revert)
            {
                last_refs.push(ref);
                ref = d;
            }
            else
            {
                ref = d;
            }
            },1000);
        };

      }

      heriarchy_2015 = [
        "Shahzad Ahmad",
        90000,
        90000,
        {
          "PSO": [
            "PSO",
            30000,
            30000,
            {
              "wolfgang": [
                "Wolgang Balduin",
                30000,
                30000,
                {
                  "IC": [
                    "Implementation",
                    7500,
                    7500,
                    {
                      "Principal": [
                        "Principal IC",
                        7500,
                        7500,
                        {
                          "Senior": [
                            "Senior IC",
                            7500,
                            7500,
                            {
                              "IC": [
                                "IC",
                                7500,
                                7500,
                                {
                                  "MicroSourcing": [
                                    "MicroSourcing",
                                    7500,
                                    7500,
                                    {}
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ],
                  "SEs": [
                    "Systems Engineers",
                    7500,
                    7500,
                    {
                      "Senior": [
                        "Senior SE",
                        7500,
                        7500,
                        {
                          "SE": [
                            "SE",
                            7500,
                            7500,
                            {
                              "AssSE": [
                                "Associate SE",
                                7500,
                                7500,
                                {}
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ],
                  "AppDev": [
                    "App Dev",
                    7500,
                    7500,
                    {
                      "Manager": [
                        "Manager",
                        7500,
                        7500,
                        {
                          "Senior": [
                            "Senior Dev",
                            3750,
                            3750,
                            {
                              "Dev": [
                                "Dev",
                                3750,
                                3750,
                                {}
                              ]
                            }
                          ],
                          "Consultants": [
                            "Consultants",
                            3750,
                            3750,
                            {}
                          ]
                        }
                      ]
                    }
                  ],
                  "PM": [
                    "Project Mgt",
                    7500,
                    7500,
                    {
                      "Lead": [
                        "Lead PM",
                        7500,
                        7500,
                        {
                          "Senior": [
                            "Senior PM",
                            7500,
                            7500,
                            {
                              "PM": [
                                "PM",
                                7500,
                                7500,
                                {}
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ],
          "Support": [
            "Support",
            30000,
            30000,
            {
              "Daniel": [
                "Daniel Chen",
                30000,
                30000,
                {
                  "TTLs": [
                    "TTLs",
                    10000,
                    10000,
                    {
                      "SE": [
                        "SE",
                        10000,
                        10000,
                        {
                          "AssociateSE": [
                            "Associate SE",
                            10000,
                            10000,
                            {
                              "Interns": [
                                "Interns",
                                10000,
                                10000,
                                {}
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ],
                  "PrincipalSEs": [
                    "Principal SEs",
                    10000,
                    10000,
                    {}
                  ],
                  "SDMs": [
                    "SDMs",
                    10000,
                    10000,
                    {}
                  ]

                }
              ]
            }
          ],
          "SalesOps": [
            "Sales Ops",
            30000,
            30000,
            {
              "DevSolutions": [
                "Dev Solutions",
                6000,
                6000,
                {
                  "SeniorDevSE": [
                    "Senior Dev SE",
                    6000,
                    6000,
                    {
                      "Dev SE": [
                        "Dev SE",
                        6000,
                        6000,
                        {}
                      ]
                    }
                  ]
                }
              ],
              "Consultants": [
                "Consultants",
                6000,
                6000,
                {
                  "Strategic": [
                    "Strategic",
                    6000,
                    6000,
                    {
                      "Principal": [
                        "Principal",
                        6000,
                        6000,
                        {
                          "Senior": [
                            "Senior",
                            6000,
                            6000,
                            {}
                          ]
                        }
                      ]
                    }
                  ]
                }
              ],
              "SeniorManager": [
                "Senior Manager",
                6000,
                6000,
                {
                  "Manager": [
                    "Manager",
                    6000,
                    6000,
                    {
                      "TeamLead": [
                        "Team Lead",
                        6000,
                        6000,
                        {
                          "SeniorPrinc": [
                            "Senior Principal SE",
                            6000,
                            6000,
                            {
                              "Princ": [
                                "Principal SE",
                                6000,
                                6000,
                                {
                                  "Senior": [
                                    "Senior SE",
                                    6000,
                                    6000,
                                    {
                                      "SEII": [
                                        "SE II",
                                        6000,
                                        6000,
                                        {
                                          "SEI": [
                                            "SE I",
                                            6000,
                                            6000,
                                            {
                                              "Inside": [
                                                "Inside Sales SE",
                                                6000,
                                                6000,
                                                {}
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ],
              "Analysts": [
                "Analysts",
                6000,
                6000,
                {
                }
              ],
              "Specialists": [
                "Specialists",
                6000,
                6000,
                {
                }
              ]
            }
          ],
        }
      ];

      heriarchy_2016 = [
        "Shahzad Ahmad",
        120000,
        120000,
        {
          "PSO": [
            "PSO",
            30000,
            30000,
            {
              "wolfgang": [
                "Wolgang Balduin",
                30000,
                30000,
                {
                  "IC": [
                    "Implementation",
                    7500,
                    7500,
                    {
                      "Principal": [
                        "Principal IC",
                        7500,
                        7500,
                        {
                          "Senior": [
                            "Senior IC",
                            7500,
                            7500,
                            {
                              "IC": [
                                "IC",
                                7500,
                                7500,
                                {
                                  "MicroSourcing": [
                                    "MicroSourcing",
                                    7500,
                                    7500,
                                    {}
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ],
                  "SEs": [
                    "Systems Engineers",
                    7500,
                    7500,
                    {
                      "Senior": [
                        "Senior SE",
                        7500,
                        7500,
                        {
                          "SE": [
                            "SE",
                            7500,
                            7500,
                            {
                              "AssSE": [
                                "Associate SE",
                                7500,
                                7500,
                                {}
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ],
                  "AppDev": [
                    "App Dev",
                    7500,
                    7500,
                    {
                      "Manager": [
                        "Manager",
                        7500,
                        7500,
                        {
                          "Senior": [
                            "Senior Dev",
                            3750,
                            3750,
                            {
                              "Dev": [
                                "Dev",
                                3750,
                                3750,
                                {}
                              ]
                            }
                          ],
                          "Consultants": [
                            "Consultants",
                            3750,
                            3750,
                            {}
                          ]
                        }
                      ]
                    }
                  ],
                  "PM": [
                    "Project Mgt",
                    7500,
                    7500,
                    {
                      "Lead": [
                        "Lead PM",
                        7500,
                        7500,
                        {
                          "Senior": [
                            "Senior PM",
                            7500,
                            7500,
                            {
                              "PM": [
                                "PM",
                                7500,
                                7500,
                                {}
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ],
          "Support": [
            "Support",
            30000,
            30000,
            {
              "Daniel": [
                "Daniel Chen",
                30000,
                30000,
                {
                  "TTLs": [
                    "TTLs",
                    10000,
                    10000,
                    {
                      "SE": [
                        "SE",
                        10000,
                        10000,
                        {
                          "AssociateSE": [
                            "Associate SE",
                            10000,
                            10000,
                            {
                              "Interns": [
                                "Interns",
                                10000,
                                10000,
                                {}
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ],
                  "PrincipalSEs": [
                    "Principal SEs",
                    10000,
                    10000,
                    {}
                  ],
                  "SDMs": [
                    "SDMs",
                    10000,
                    10000,
                    {}
                  ]

                }
              ]
            }
          ],
          "SalesOps": [
            "Sales Ops",
            30000,
            30000,
            {
              "DevSolutions": [
                "Dev Solutions",
                6000,
                6000,
                {
                  "SeniorDevSE": [
                    "Senior Dev SE",
                    6000,
                    6000,
                    {
                      "Dev SE": [
                        "Dev SE",
                        6000,
                        6000,
                        {}
                      ]
                    }
                  ]
                }
              ],
              "Consultants": [
                "Consultants",
                6000,
                6000,
                {
                  "Strategic": [
                    "Strategic",
                    6000,
                    6000,
                    {
                      "Principal": [
                        "Principal",
                        6000,
                        6000,
                        {
                          "Senior": [
                            "Senior",
                            6000,
                            6000,
                            {}
                          ]
                        }
                      ]
                    }
                  ]
                }
              ],
              "SeniorManager": [
                "Senior Manager",
                6000,
                6000,
                {
                  "Manager": [
                    "Manager",
                    6000,
                    6000,
                    {
                      "TeamLead": [
                        "Team Lead",
                        6000,
                        6000,
                        {
                          "SeniorPrinc": [
                            "Senior Principal SE",
                            6000,
                            6000,
                            {
                              "Princ": [
                                "Principal SE",
                                6000,
                                6000,
                                {
                                  "Senior": [
                                    "Senior SE",
                                    6000,
                                    6000,
                                    {
                                      "SEII": [
                                        "SE II",
                                        6000,
                                        6000,
                                        {
                                          "SEI": [
                                            "SE I",
                                            6000,
                                            6000,
                                            {
                                              "Inside": [
                                                "Inside Sales SE",
                                                6000,
                                                6000,
                                                {}
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ],
              "Analysts": [
                "Analysts",
                6000,
                6000,
                {
                }
              ],
              "Specialists": [
                "Specialists",
                6000,
                6000,
                {
                }
              ]
            }
          ],
          "FieldOps": [
              "Field Ops",
              30000,
              30000,
              {
                "Marco": [
                  "Marco Van Veen",
                  15000,
                  15000,
                  {
                    "FieldOps": [
                      "Field Ops",
                      15000,
                      15000,
                      {}
                    ]
                  }
                ],
                "Craig": [
                  "Craig Stevenson",
                  15000,
                  15000,
                  {
                    "FieldOps": [
                      "Field Ops",
                      15000,
                      15000,
                      {}
                    ]
                  }
                ]
              }
          ]
        }
      ];

      function init_plots(json)
      {
          init_code_hierarchy_plot("code_hierarchy", json);
      };

      init_plots(heriarchy_2015);
    });
  </script>
</body>
